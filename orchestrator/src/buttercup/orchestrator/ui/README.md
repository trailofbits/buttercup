# Buttercup UI Component

## Overview

The Buttercup UI is the main web interface and API gateway for the Buttercup platform. It provides a FastAPI-based HTTP API for managing challenges, tasks, submissions, and integration with the Competition Reference System (CRS). The UI is designed to be extensible, secure, and easy to operate, serving as the central point for orchestrating CTF-style competitions and automated vulnerability discovery workflows.

## Features

- **RESTful API** for:
  - Listing and managing challenges
  - Submitting and tracking tasks
  - Submitting and retrieving bundles, patches, SARIF reports, and more
  - Interfacing with the CRS for automated evaluation
  - File serving for challenge and tooling artifacts
- **Challenge Orchestration**: Handles the full lifecycle of a challenge, from repository download to task submission and result collection.
- **CRS Integration**: Submits tasks and receives results from the Competition Reference System.
- **Extensible Models**: Uses Pydantic for strong typing and easy extension.
- **Configurable**: All major settings are configurable via environment variables or a `.env` file.
- **Logging and Error Handling**: Rich logging and robust error handling for all endpoints.

## Architecture

- **FastAPI Application**: All endpoints are defined in `main.py` using FastAPI.
- **Modular Services**: Business logic is encapsulated in service classes (e.g., `ChallengeService`, `CRSClient`).
- **Typed Models**: All API payloads and internal data structures use Pydantic models for validation and documentation.
- **Configuration**: Centralized in `config.py` using Pydantic settings.
- **File Structure**:

```
ui/
├── config.py                # Settings and configuration
├── competition_api/
│   ├── main.py              # FastAPI endpoints
│   ├── models/              # Pydantic models for API and CRS
│   └── services/            # Business logic (challenge, CRS, etc.)
└── ...
```

## Configuration

The UI is configured via environment variables (with the `BUTTERCUP_UI_` prefix) or a `.env` file. Key settings include:

- `BUTTERCUP_UI_HOST`: Host to bind the server (default: `0.0.0.0`)
- `BUTTERCUP_UI_PORT`: Port to bind the server (default: `1323`)
- `BUTTERCUP_UI_STORAGE_DIR`: Directory for storing tarballs and artifacts (default: `/tmp/buttercup-storage`)
- `BUTTERCUP_UI_CRS_BASE_URL`: CRS API base URL (default: `http://localhost:8080`)
- `BUTTERCUP_UI_CRS_KEY_ID` / `BUTTERCUP_UI_CRS_KEY_TOKEN`: CRS authentication (optional)
- `BUTTERCUP_UI_LOG_LEVEL`: Log level (default: `debug`)

Example:
```bash
export BUTTERCUP_UI_CRS_BASE_URL="http://your-crs-server:8000"
export BUTTERCUP_UI_STORAGE_DIR="/tmp/buttercup-ui"
export BUTTERCUP_UI_LOG_LEVEL="info"
export BUTTERCUP_UI_CRS_KEY_ID="515cc8a0-3019-4c9f-8c1c-72d0b54ae561"
export BUTTERCUP_UI_CRS_KEY_TOKEN="VGuAC8axfOnFXKBB7irpNDOKcDjOlnyB"
```

## API Usage

The UI exposes a RESTful API. Example endpoints:

- **Ping**: `GET /v1/ping/` — Health check
- **List Challenges**: `GET /v1/request/list/`
- **Submit Task**: `POST /v1/request/{challenge_name}`
- **Serve Files**: `GET /files/{tarball_name}.tar.gz`
- **CRS Connectivity**: `GET /v1/crs-ping/`
- **Bundles, Patches, SARIF, POVs**: Various `/v1/task/{task_id}/...` endpoints

Example: Submit a challenge task
```bash
curl -X POST "http://localhost:1323/v1/request/upstream-libpng" \
     -H "Content-Type: application/json" \
     -d '{"duration_secs": 3600}'
```

See the OpenAPI/Swagger docs (auto-generated by FastAPI) for full endpoint details.

## Development & Testing

- **Run the UI locally**:
  ```bash
  buttercup-ui
  # or
  uvicorn buttercup.orchestrator.ui.competition_api.main:app --reload
  ```
- **Run tests**:
  ```bash
  pytest test/
  ```
- **Extending**: Add new endpoints or services in the `competition_api` module. Add new models in `models/`.

## Extensibility & Future Enhancements

- **Dynamic Challenge Management**: Planned support for adding/removing challenges at runtime.
- **UI Frontend**: (Planned) Web dashboard for monitoring and manual operations.
- **Authentication & Authorization**: (Planned) Role-based access control for sensitive endpoints.
- **Metrics & Monitoring**: (Planned) Prometheus/Grafana integration.
- **Delta Tasks & Caching**: Support for delta tasks and artifact caching.
