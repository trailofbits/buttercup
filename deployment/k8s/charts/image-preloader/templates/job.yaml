{{- if .Values.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-image-preloader
  labels:
    app: image-preloader
spec:
  backoffLimit: {{ .Values.backoffLimit | default 3 }}
  template:
    metadata:
      labels:
        app: image-preloader
    spec:
      restartPolicy: {{ .Values.restartPolicy | default "OnFailure" }}
      {{- include "buttercup.imagePullSecrets" . | nindent 6 }}
      initContainers:
      {{- include "buttercup.waitForDocker" . | nindent 6 }}
      containers:
      - name: image-preloader
        image: "docker:cli"
        resources:
          {{- toYaml .Values.resources | nindent 10 }}
        command:
          - "/bin/sh"
          - "-c"
          - |
            echo "Starting Docker image preloader..."

            # Wait for Docker daemon to be ready
            until docker info > /dev/null 2>&1; do
              echo "Waiting for Docker daemon to be ready..."
              sleep 2
            done

            echo "Docker daemon ready, starting to pull images..."

            # Pull all configured images
            {{- range $version := .Values.versions }}
            {{- range $image := $.Values.baseImages }}
            echo "Pulling {{ $image }}:{{ $version }}..."
            docker pull {{ $image }}:{{ $version }}
            if [ $? -ne 0 ]; then
              echo "Failed to pull {{ $image }}:{{ $version }}"
              exit 1
            fi
            {{- end }}
            {{- end }}

            echo "All images pulled successfully. Running system prune..."

            # Clean up unused images, volumes, etc.
            docker system prune -f

            echo "Image preloading and cleanup complete!"
        volumeMounts:
        {{- include "buttercup.standardVolumeMounts" (dict "usesTasksStorage" false) | nindent 8 }}
        {{- include "buttercup.nodeLocalVolumeMount" . | nindent 8 }}
        {{- include "buttercup.dockerSocketVolumeMount" . | nindent 8 }}
        env:
        {{- include "buttercup.env.dockerSocket" . | nindent 10 }}
      volumes:
      {{- include "buttercup.volumes.scratch" . | nindent 6 }}
      {{- include "buttercup.dockerSocketVolume" . | nindent 6 }}
      {{- include "buttercup.nodeLocalVolume" . | nindent 6 }}
{{- end }}
