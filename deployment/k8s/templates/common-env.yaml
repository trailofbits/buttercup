{{/*
Define core system variables that are consistent across services
*/}}

{{- define "buttercup.core.crashDirCountLimit" -}}
20
{{- end -}}

{{- define "buttercup.core.redisUrl" -}}
redis://{{ .Release.Name }}-redis-master:6379
{{- end -}}

{{- define "buttercup.core.logLevel" -}}
{{- .Values.logLevel | default "debug" -}}
{{- end -}}

{{- define "buttercup.core.logMaxLineLength" -}}
{{ int .Values.logMaxLineLength | default .Values.global.logMaxLineLength }}
{{- end -}}

{{- define "buttercup.core.dockerEndpoint" -}}
tcp://localhost:2375
{{- end -}}

{{/*
Define a unique Docker socket path using the release name and namespace
*/}}
{{- define "buttercup.core.uniqueDockerSocketDir" -}}
/var/run/dind-{{ .Release.Namespace }}-{{ .Release.Name }}
{{- end -}}

{{- define "buttercup.core.dockerSocketPath" -}}
{{ include "buttercup.core.uniqueDockerSocketDir" . }}/docker.sock
{{- end -}}

{{/*
Define the full Docker socket path
*/}}
{{- define "buttercup.core.dockerSocketEndpoint" -}}
unix://{{ include "buttercup.core.dockerSocketPath" . }}
{{- end -}}

{{- define "buttercup.core.litellmEndpoint" -}}
http://{{ .Release.Name }}-litellm:4000
{{- end -}}

{{/*
Define common variables by categories
*/}}
{{- define "buttercup.env.dirs" }}
- name: CRS_SCRATCH_DIR
  value: {{ include "buttercup.nodeLocalCrsScratchPath" . }}
- name: TASKS_STORAGE_DIR
  value: {{ include "buttercup.nodeLocalTasksStoragePath" . }}
{{- end }}

{{- define "buttercup.env.nodeData" }}
{{- if .Values.global.volumes.nodeLocal.enabled }}
- name: NODE_DATA_DIR
  value: "{{ .Values.global.volumes.nodeLocal.mountPath }}"
{{- end }}
{{- end }}

{{- define "buttercup.env.redis" }}
- name: REDIS_URL
  value: {{ include "buttercup.core.redisUrl" . }}
{{- end }}

{{/*
Define Docker Host environment variable for Unix socket
*/}}
{{- define "buttercup.env.dockerSocket" }}
- name: DOCKER_HOST
  value: {{ include "buttercup.core.dockerSocketEndpoint" . }}
{{- end }}

{{- define "buttercup.env.llm" }}
- name: BUTTERCUP_LITELLM_KEY
  valueFrom:
    secretKeyRef:
      name: {{ .secretName }}
      key: {{ .secretKey }}
- name: BUTTERCUP_LITELLM_HOSTNAME
  value: {{ include "buttercup.core.litellmEndpoint" . }}
{{- end }}

{{- define "buttercup.env.telemetry" }}
- name: OTEL_EXPORTER_OTLP_ENDPOINT
  value: "{{ .Values.global.otel.endpoint }}"
- name: OTEL_EXPORTER_OTLP_HEADERS
  value: "Authorization=Basic {{ .Values.global.otel.token }}"
- name: OTEL_EXPORTER_OTLP_PROTOCOL
  value: "{{ .Values.global.otel.protocol | default "grpc" }}"
- name: CRS_INSTANCE_ID
  valueFrom:
    configMapKeyRef:
      name: crs-instance-id
      key: crs-instance-id
{{- end }}

{{- define "buttercup.env.timeouts" }}
- name: BUILD_TASK_TIMEOUT_MS
  value: "{{ int .Values.global.queueTimeouts.buildTaskTimeoutMs | default 120000 }}"
- name: BUILD_OUTPUT_TASK_TIMEOUT_MS
  value: "{{ int .Values.global.queueTimeouts.buildOutputTaskTimeoutMs | default 120000 }}"
- name: DOWNLOAD_TASK_TIMEOUT_MS
  value: "{{ int .Values.global.queueTimeouts.downloadTaskTimeoutMs | default 120000 }}"
- name: READY_TASK_TIMEOUT_MS
  value: "{{ int .Values.global.queueTimeouts.readyTaskTimeoutMs | default 120000 }}"
- name: DELETE_TASK_TIMEOUT_MS
  value: "{{ int .Values.global.queueTimeouts.deleteTaskTimeoutMs | default 120000 }}"
- name: CRASH_TASK_TIMEOUT_MS
  value: "{{ int .Values.global.queueTimeouts.crashTaskTimeoutMs | default 120000 }}"
- name: PATCH_TASK_TIMEOUT_MS
  value: "{{ int .Values.global.queueTimeouts.patchTaskTimeoutMs | default 120000 }}"
- name: CONFIRMED_VULNERABILITIES_TASK_TIMEOUT_MS
  value: "{{ int .Values.global.queueTimeouts.confirmedVulnerabilitiesTaskTimeoutMs | default 120000 }}"
- name: INDEX_TASK_TIMEOUT_MS
  value: "{{ int .Values.global.queueTimeouts.indexTaskTimeoutMs | default 120000 }}"
- name: INDEX_OUTPUT_TASK_TIMEOUT_MS
  value: "{{ int .Values.global.queueTimeouts.indexOutputTaskTimeoutMs | default 120000 }}"
- name: TRACED_VULNERABILITIES_TASK_TIMEOUT_MS
  value: "{{ int .Values.global.queueTimeouts.tracedVulnerabilitiesTaskTimeoutMs | default 120000 }}"
{{- end }}

{{/*
Define persistent log directory environment variable
*/}}
{{- define "buttercup.env.persistentLogDir" }}
- name: PERSISTENT_LOG_DIR
  value: "{{ .Values.global.persistentLogDir | default (include "buttercup.nodeLocalCrsScratchPath" .) }}"
{{- end }}

{{/*
Define common environment for all services
*/}}
{{- define "buttercup.commonEnv" }}
{{- include "buttercup.env.telemetry" . | nindent 0 }}
{{- include "buttercup.env.timeouts" . | nindent 0 }}
{{- include "buttercup.env.dirs" . | nindent 0 }}
{{- include "buttercup.env.nodeData" . | nindent 0 }}
{{- include "buttercup.env.persistentLogDir" . | nindent 0 }}
{{- end }}

{{/*
Define Langfuse environment variables
*/}}
{{- define "buttercup.env.langfuse" }}
{{- if .Values.global.langfuse.enabled }}
{{- /* Set Langfuse environment variables from Kubernetes secret */ -}}
- name: LANGFUSE_HOST
  valueFrom:
    secretKeyRef:
      name: {{ .Release.Name }}-langfuse-secrets
      key: LANGFUSE_HOST
- name: LANGFUSE_PUBLIC_KEY
  valueFrom:
    secretKeyRef:
      name: {{ .Release.Name }}-langfuse-secrets
      key: LANGFUSE_PUBLIC_KEY
- name: LANGFUSE_SECRET_KEY
  valueFrom:
    secretKeyRef:
      name: {{ .Release.Name }}-langfuse-secrets
      key: LANGFUSE_SECRET_KEY
{{- end }}
{{- end }}

{{/*
Service-specific environment variables that utilize the standardized variables
*/}}
{{- define "buttercup.programModelEnv" }}
- name: BUTTERCUP_PROGRAM_MODEL_LOG_LEVEL
  value: {{ include "buttercup.core.logLevel" . }}
- name: BUTTERCUP_PROGRAM_MODEL_LOG_MAX_LINE_LENGTH
  value: "{{ include "buttercup.core.logMaxLineLength" . }}"
- name: BUTTERCUP_PROGRAM_MODEL_SERVE__REDIS_URL
  value: {{ include "buttercup.core.redisUrl" . }}
- name: BUTTERCUP_PROGRAM_MODEL_SERVE__SLEEP_TIME
  value: "5"
- name: BUTTERCUP_PROGRAM_MODEL_GRAPHDB_URL
  value: "ws://{{ .Release.Name }}-janusgraph:8182/gremlin"
- name: BUTTERCUP_PROGRAM_MODEL_SERVE__PYTHON
  value: "python"
- name: BUTTERCUP_PROGRAM_MODEL_SCRATCH_DIR
  value: {{ include "buttercup.nodeLocalCrsScratchPath" . }}
- name: BUTTERCUP_PROGRAM_MODEL_GRAPHDB_ENABLED
  value: "false"
{{- end }}

{{- define "buttercup.downloaderEnv" }}
- name: BUTTERCUP_DOWNLOADER_LOG_LEVEL
  value: {{ include "buttercup.core.logLevel" . }}
- name: BUTTERCUP_DOWNLOADER_LOG_MAX_LINE_LENGTH
  value: "{{ include "buttercup.core.logMaxLineLength" . }}"
- name: BUTTERCUP_DOWNLOADER_DOWNLOAD_DIR
  value: {{ include "buttercup.nodeLocalTasksStoragePath" . }}
- name: BUTTERCUP_DOWNLOADER_SERVE__SLEEP_TIME
  value: "5"
- name: BUTTERCUP_DOWNLOADER_SERVE__REDIS_URL
  value: {{ include "buttercup.core.redisUrl" . }}
{{- end }}

{{- define "buttercup.taskServerEnv" }}
- name: BUTTERCUP_TASK_SERVER_REDIS_URL
  value: {{ include "buttercup.core.redisUrl" . }}
- name: BUTTERCUP_TASK_SERVER_LOG_LEVEL
  value: {{ include "buttercup.core.logLevel" . }}
- name: BUTTERCUP_TASK_SERVER_LOG_MAX_LINE_LENGTH
  value: "{{ include "buttercup.core.logMaxLineLength" . }}"
- name: BUTTERCUP_TASK_SERVER_HOST
  value: "0.0.0.0"
- name: BUTTERCUP_TASK_SERVER_PORT
  value: "{{ .Values.port | default 8000 }}"
- name: BUTTERCUP_TASK_SERVER_WORKERS
  value: "{{ .Values.workers | default 1 }}"
- name: BUTTERCUP_TASK_SERVER_COMPETITION_API_URL
  valueFrom:
    configMapKeyRef:
      name: {{ .Release.Name }}-crs-config
      key: COMPETITION_API_URL
- name: BUTTERCUP_TASK_SERVER_COMPETITION_API_USERNAME
  valueFrom:
    configMapKeyRef:
      name: {{ .Release.Name }}-crs-config
      key: COMPETITION_API_KEY_ID
- name: BUTTERCUP_TASK_SERVER_COMPETITION_API_PASSWORD
  valueFrom:
    secretKeyRef:
      name: {{ .Release.Name }}-crs-config
      key: COMPETITION_API_KEY_TOKEN
- name: BUTTERCUP_TASK_SERVER_API_KEY_ID
  valueFrom:
    configMapKeyRef:
      name: {{ .Release.Name }}-crs-config
      key: CRS_API_KEY_ID
- name: BUTTERCUP_TASK_SERVER_API_TOKEN_HASH
  valueFrom:
    secretKeyRef:
      name: {{ .Release.Name }}-crs-config
      key: CRS_API_KEY_TOKEN_HASH
{{- end }}

{{- define "buttercup.schedulerEnv" }}
- name: BUTTERCUP_SCHEDULER_LOG_LEVEL
  value: {{ include "buttercup.core.logLevel" . }}
- name: BUTTERCUP_SCHEDULER_LOG_MAX_LINE_LENGTH
  value: "{{ include "buttercup.core.logMaxLineLength" . }}"
- name: BUTTERCUP_SCHEDULER_TASKS_STORAGE_DIR
  value: {{ include "buttercup.nodeLocalTasksStoragePath" . }}
- name: BUTTERCUP_SCHEDULER_SCRATCH_DIR
  value: {{ include "buttercup.nodeLocalCrsScratchPath" . }}
- name: BUTTERCUP_SCHEDULER_SERVE__SLEEP_TIME
  value: "5"
- name: BUTTERCUP_SCHEDULER_SERVE__REDIS_URL
  value: {{ include "buttercup.core.redisUrl" . }}
- name: BUTTERCUP_SCHEDULER_SERVE__COMPETITION_API_URL
  valueFrom:
    configMapKeyRef:
      name: {{ .Release.Name }}-crs-config
      key: COMPETITION_API_URL
- name: COMPETITION_API_KEY_ID
  valueFrom:
    configMapKeyRef:
      name: {{ .Release.Name }}-crs-config
      key: COMPETITION_API_KEY_ID
- name: COMPETITION_API_KEY_TOKEN
  valueFrom:
    secretKeyRef:
      name: {{ .Release.Name }}-crs-config
      key: COMPETITION_API_KEY_TOKEN
{{- end }}

{{- define "buttercup.patcherEnv" }}
- name: BUTTERCUP_PATCHER_LOG_LEVEL
  value: {{ include "buttercup.core.logLevel" . }}
- name: BUTTERCUP_PATCHER_LOG_MAX_LINE_LENGTH
  value: "{{ include "buttercup.core.logMaxLineLength" . }}"
- name: BUTTERCUP_PATCHER_TASK_STORAGE_DIR
  value: {{ include "buttercup.nodeLocalTasksStoragePath" . }}
- name: BUTTERCUP_PATCHER_SCRATCH_DIR
  value: {{ include "buttercup.nodeLocalCrsScratchPath" . }}
- name: BUTTERCUP_PATCHER_SERVE__SLEEP_TIME
  value: "5"
- name: BUTTERCUP_PATCHER_SERVE__REDIS_URL
  value: {{ include "buttercup.core.redisUrl" . }}
- name: BUTTERCUP_PATCHER_DEV_MODE
  value: "false"
- name: TOB_PATCHER_MAX_PATCH_RETRIES
  value: {{ int .Values.maxPatchRetries | default 15 | quote }}
- name: TOB_PATCHER_CTX_RETRIEVER_RECURSION_LIMIT
  value: {{ int .Values.maxContextRetrieverRecursionLimit | default 80 | quote }}
- name: TOB_PATCHER_MAX_MINUTES_RUN_POVS
  value: {{ int .Values.maxMinutesRunPOVs | default 30 | quote }}
{{- end }}

{{- define "buttercup.seedGenEnv" }}
- name: BUTTERCUP_SEED_GEN_LOG_LEVEL
  value: {{ include "buttercup.core.logLevel" . }}
- name: BUTTERCUP_SEED_GEN_LOG_MAX_LINE_LENGTH
  value: "{{ include "buttercup.core.logMaxLineLength" . }}"
- name: BUTTERCUP_SEED_GEN_SERVER__REDIS_URL
  value: {{ include "buttercup.core.redisUrl" . }}
- name: BUTTERCUP_SEED_GEN_WDIR
  value: {{ include "buttercup.nodeLocalCrsScratchPath" . }}
- name: BUTTERCUP_SEED_GEN_SERVER__SLEEP_TIME
  value: "5"
- name: BUTTERCUP_SEED_GEN_SERVER__CRASH_DIR_COUNT_LIMIT
  value: {{ include "buttercup.core.crashDirCountLimit" . | quote }}
- name: BUTTERCUP_SEED_GEN_SERVER__MAX_CORPUS_SEED_SIZE
  value: {{ int .Values.maxCorpusSeedSize | quote }}
- name: BUTTERCUP_SEED_GEN_SERVER__MAX_POV_SIZE
  value: {{ int .Values.global.maxPovSize | quote }}
{{- end }}

{{- define "buttercup.buildBotEnv" }}
- name: BUTTERCUP_FUZZER_LOG_LEVEL
  value: {{ include "buttercup.core.logLevel" . }}
- name: BUTTERCUP_FUZZER_LOG_MAX_LINE_LENGTH
  value: "{{ include "buttercup.core.logMaxLineLength" . }}"
{{- end }}

{{- define "buttercup.fuzzerBotEnv" }}
- name: BUTTERCUP_FUZZER_LOG_LEVEL
  value: {{ include "buttercup.core.logLevel" . }}
- name: BUTTERCUP_FUZZER_LOG_MAX_LINE_LENGTH
  value: "{{ include "buttercup.core.logMaxLineLength" . }}"
- name: BUTTERCUP_FUZZER_MAX_POV_SIZE
  value: {{ int .Values.global.maxPovSize | quote }}
{{- end }}

{{- define "buttercup.povReproducerEnv" }}
- name: BUTTERCUP_POV_REPRODUCER_REDIS_URL
  value: {{ include "buttercup.core.redisUrl" . }}
- name: BUTTERCUP_POV_REPRODUCER_LOG_LEVEL
  value: {{ include "buttercup.core.logLevel" . }}
- name: BUTTERCUP_POV_REPRODUCER_SLEEP_TIME
  value: {{ .Values.povReproducer.sleepTime | quote }}
- name: BUTTERCUP_POV_REPRODUCER_MAX_RETRIES
  value: {{ .Values.povReproducer.maxRetries | quote }}
{{- end }}

{{- define "buttercup.scratchCleanerEnv" }}
- name: BUTTERCUP_SCRATCH_CLEANER_REDIS_URL
  value: {{ include "buttercup.core.redisUrl" . }}
- name: BUTTERCUP_SCRATCH_CLEANER_LOG_LEVEL
  value: {{ include "buttercup.core.logLevel" . }}
- name: BUTTERCUP_SCRATCH_CLEANER_SLEEP_TIME
  value: {{ .Values.sleepTime | quote }}
- name: BUTTERCUP_SCRATCH_CLEANER_DELETE_OLD_TASKS_SCRATCH_DELTA_SECONDS
  value: {{ .Values.deleteOldTasksScratchDeltaSeconds | quote }}
- name: BUTTERCUP_SCRATCH_CLEANER_SCRATCH_DIR
  value: {{ include "buttercup.nodeLocalCrsScratchPath" . }}
{{- end }}


{{- define "buttercup.uiEnv" }}
- name: BUTTERCUP_UI_CRS_BASE_URL
  value: {{ .Values.global.crs.api_url | default (printf "http://%s-task-server.%s.svc.cluster.local:8000" .Release.Name .Release.Namespace) | quote }}
- name: BUTTERCUP_UI_CRS_KEY_ID
  value: {{ .Values.global.crs.api_key_id | quote }}
- name: BUTTERCUP_UI_CRS_KEY_TOKEN
  value: {{ .Values.global.crs.api_key_token | quote }}
- name: BUTTERCUP_UI_STORAGE_DIR
  value: "/data/challenges"
- name: BUTTERCUP_UI_RUN_DATA_DIR
  value: "/tmp/buttercup-run-data"
- name: BUTTERCUP_UI_EXTERNAL_HOST
  value: {{ .Values.service.external_host | default (printf "%s-ui.%s.svc.cluster.local" .Release.Name .Release.Namespace) | quote }}
- name: BUTTERCUP_UI_HOST
  value: {{ .Values.service.host | default "0.0.0.0" | quote }}
- name: BUTTERCUP_UI_PORT
  value: {{ .Values.service.port | quote }}
- name: BUTTERCUP_UI_LOG_LEVEL
  value: {{ include "buttercup.core.logLevel" . }}
- name: GITHUB_PAT
  valueFrom:
    secretKeyRef:
      name: ghcr
      key: pat
- name: GITHUB_USERNAME
  valueFrom:
    secretKeyRef:
      name: ghcr
      key: username
{{- end }}


