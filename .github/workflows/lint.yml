name: Lint

on:
  push:
    branches:
      - main
    # Always run full suite on main branch
  pull_request:
    paths:
      # Run if any Python code changes
      - '**/*.py'
      # Run if any dependencies change
      - '**/pyproject.toml'
      - '**/uv.lock'
      - '**/requirements*.txt'
      # Run if build/CI configuration changes
      - '**/Makefile'
      - '.github/workflows/lint.yml'
      - '.github/workflows/tests.yml'
      # Run if protobuf definitions change
      - '**/*.proto'
      - 'protoc.sh'
      # Run if Docker configuration changes
      - '**/Dockerfile'
      - '**/.dockerignore'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    strategy:
      fail-fast: false  # Continue running other components even if one fails
      matrix:
        component:
          [common, orchestrator, program-model, seed-gen, patcher]

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Setup uv cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.local/share/uv
          key: ${{ runner.os }}-uv-${{ matrix.component }}-${{ hashFiles(format('{0}/uv.lock', matrix.component)) }}
          restore-keys: |
            ${{ runner.os }}-uv-${{ matrix.component }}-
            ${{ runner.os }}-uv-

      - name: Setup ${{ matrix.component }} component
        run: uv sync --all-extras
        working-directory: ${{ matrix.component }}

      - name: Run ruff on ${{ matrix.component }}
        run: |
          uv run ruff format --check --diff
          uv run ruff check --output-format=github
        working-directory: ${{ matrix.component }}

      - name: Run mypy on ${{ matrix.component }}
        run: uv run mypy
        working-directory: ${{ matrix.component }}

  # Fuzzer is experimental and may have linting issues
  # Run it separately so it doesn't block other components
  lint-fuzzer-experimental:
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't fail the overall CI if fuzzer has issues
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Setup uv cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.local/share/uv
          key: ${{ runner.os }}-uv-fuzzer-${{ hashFiles('fuzzer/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-fuzzer-
            ${{ runner.os }}-uv-

      - name: Setup fuzzer component
        run: uv sync --all-extras
        working-directory: fuzzer

      - name: Run ruff on fuzzer (experimental)
        run: |
          uv run ruff format --check --diff
          uv run ruff check --output-format=github
        working-directory: fuzzer

      - name: Run mypy on fuzzer (experimental)
        run: uv run mypy
        working-directory: fuzzer
        continue-on-error: true  # Fuzzer's type checking is known to have issues

  check-protobuf:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Generate protobufs
        run: |
          # Generate fresh protobufs
          ./protoc.sh

          # Check if any files were modified
          if ! git diff --quiet common/src/buttercup/common/datastructures; then
            echo "Error: Generated protobufs differ from committed files"
            exit 1
          fi
