name: Lint

on:
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    strategy:
      matrix:
        component:
          [common, orchestrator, fuzzer, program-model, seed-gen, patcher]

    runs-on: ubuntu-latest
    continue-on-error: ${{ matrix.component == 'fuzzer' }}
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Setup uv cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.local/share/uv
          key: ${{ runner.os }}-uv-${{ matrix.component }}-${{ hashFiles(format('{0}/uv.lock', matrix.component)) }}
          restore-keys: |
            ${{ runner.os }}-uv-${{ matrix.component }}-
            ${{ runner.os }}-uv-

      - name: Setup ${{ matrix.component }} component
        run: uv sync --all-extras
        working-directory: ${{ matrix.component }}

      - name: Run ruff on ${{ matrix.component }}
        run: |
          uv run ruff format --check --diff
          uv run ruff check --output-format=github
        working-directory: ${{ matrix.component }}

      - name: Run mypy on ${{ matrix.component }}
        run: uv run mypy
        working-directory: ${{ matrix.component }}
        continue-on-error: ${{ matrix.component == 'fuzzer' }}

  check-protobuf:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Generate protobufs
        run: |
          # Generate fresh protobufs
          ./protoc.sh

          # Check if any files were modified
          if ! git diff --quiet common/src/buttercup/common/datastructures; then
            echo "Error: Generated protobufs differ from committed files"
            exit 1
          fi
