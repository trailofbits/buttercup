name: Lint

on:
  push:
    branches:
      - main
    # Always run full suite on main branch
  pull_request:
    paths:
      # Component-specific triggers
      - "common/**"
      - "orchestrator/**"
      - "fuzzer/**"
      - "program-model/**"
      - "seed-gen/**"
      - "patcher/**"
      # Workflow changes
      - ".github/workflows/lint.yml"
      - ".github/workflows/tests.yml"
      # Global configuration that affects linting
      - "Makefile"
      - "protoc.sh"
      - "**/*.proto"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Detect which components need linting based on changed files
  changes:
    runs-on: ubuntu-latest
    outputs:
      common: ${{ steps.filter.outputs.common }}
      orchestrator: ${{ steps.filter.outputs.orchestrator }}
      fuzzer: ${{ steps.filter.outputs.fuzzer }}
      program-model: ${{ steps.filter.outputs.program-model }}
      seed-gen: ${{ steps.filter.outputs.seed-gen }}
      patcher: ${{ steps.filter.outputs.patcher }}
      run-all: ${{ steps.filter.outputs.workflow || steps.filter.outputs.global }}
    steps:
      - uses: actions/checkout@v5
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            common:
              - 'common/**'
            orchestrator:
              - 'orchestrator/**'
            fuzzer:
              - 'fuzzer/**'
            program-model:
              - 'program-model/**'
            seed-gen:
              - 'seed-gen/**'
            patcher:
              - 'patcher/**'
            workflow:
              - '.github/workflows/lint.yml'
            global:
              - 'Makefile'
              - 'protoc.sh'
              - '**/*.proto'

  matrix-generator:
    runs-on: ubuntu-latest
    needs: changes
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Generate matrix
        id: set-matrix
        run: |
          components=()
          if [[ "${{ needs.changes.outputs.run-all }}" == "true" ]]; then
            components=("common" "orchestrator" "fuzzer" "program-model" "seed-gen" "patcher")
          else
            [[ "${{ needs.changes.outputs.common }}" == "true" ]] && components+=("common")
            [[ "${{ needs.changes.outputs.orchestrator }}" == "true" ]] && components+=("orchestrator")
            [[ "${{ needs.changes.outputs.fuzzer }}" == "true" ]] && components+=("fuzzer")
            [[ "${{ needs.changes.outputs.program-model }}" == "true" ]] && components+=("program-model")
            [[ "${{ needs.changes.outputs.seed-gen }}" == "true" ]] && components+=("seed-gen")
            [[ "${{ needs.changes.outputs.patcher }}" == "true" ]] && components+=("patcher")
          fi
          if [[ ${#components[@]} -eq 0 ]]; then
            echo 'matrix={"component":[]}' >> $GITHUB_OUTPUT
          else
            echo "matrix={\"component\":[$(printf '"%s",' "${components[@]}" | sed 's/,$//')]}" >> $GITHUB_OUTPUT
          fi

  lint:
    needs: [changes, matrix-generator]
    strategy:
      fail-fast: false # Continue running other components even if one fails
      matrix: ${{ fromJSON(needs.matrix-generator.outputs.matrix) }}

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Setup uv cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.local/share/uv
          key: ${{ runner.os }}-uv-${{ matrix.component }}-${{ hashFiles(format('{0}/uv.lock', matrix.component)) }}
          restore-keys: |
            ${{ runner.os }}-uv-${{ matrix.component }}-
            ${{ runner.os }}-uv-

      - name: Setup ${{ matrix.component }} component
        run: uv sync --all-extras
        working-directory: ${{ matrix.component }}

      - name: Run ruff on ${{ matrix.component }}
        run: |
          uv run ruff format --check --diff
          uv run ruff check --output-format=github
        working-directory: ${{ matrix.component }}

      - name: Run mypy on ${{ matrix.component }}
        run: uv run mypy
        working-directory: ${{ matrix.component }}

  check-protobuf:
    needs: changes
    # Run if protobuf files changed or we need to run all
    if: needs.changes.outputs.run-all == 'true' || contains(github.event.head_commit.modified, '.proto') || contains(github.event.head_commit.modified, 'protoc.sh')
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Generate protobufs
        run: |
          # Generate fresh protobufs
          ./protoc.sh

          # Check if any files were modified
          if ! git diff --quiet common/src/buttercup/common/datastructures; then
            echo "Error: Generated protobufs differ from committed files"
            exit 1
          fi
